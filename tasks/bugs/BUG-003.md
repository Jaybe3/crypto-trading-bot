# BUG-003: learning.py queries non-existent columns from trading_patterns

**Severity:** CRITICAL
**Found:** 2026-02-05
**Found By:** Audit Layer 2 (Schema) + Layer 3 (Integration)
**Status:** FIXED

## Evidence
learning.py:257-261 queries columns that don't exist in trading_patterns table:
- "name" → actual column is "description"
- "usage_count" → actual column is "times_used"
- "win_rate" → column doesn't exist; must calculate from "wins" and "losses"

Query will crash with sqlite3.OperationalError at runtime.

## Root Cause
Schema drift — code written for an older table schema with different column names.

## Fix
1. src/analysis/learning.py line 258: Fixed SELECT columns
   - Old: SELECT pattern_id, name, confidence, usage_count, win_rate, total_pnl, is_active
   - New: SELECT pattern_id, description, confidence, times_used, wins, losses, total_pnl, is_active

2. src/analysis/learning.py line 260: Fixed WHERE clause
   - Old: WHERE usage_count >= ?
   - New: WHERE times_used >= ?

3. src/analysis/learning.py line 269: Updated tuple unpacking
   - Old: for pattern_id, name, conf, usage, win_rate, pnl, active in patterns:
   - New: for pattern_id, description, conf, usage, wins, losses, pnl, active in patterns:

4. src/analysis/learning.py line 271: Calculate win_rate from wins/usage
   - Added: win_rate = wins / usage if usage > 0 else 0

5. src/analysis/learning.py line 275: pattern_data uses description
   - "name": description (keeps dict key as "name" for API compatibility)

## Verification
- Python can import the module without error
- Query columns match actual schema
- Full test suite passes (835 passed, 1 skipped)

## Fixed In
TBD - pending commit
