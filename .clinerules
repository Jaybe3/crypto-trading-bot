# .clinerules - Crypto Trading Bot Development Rules

## CRITICAL: Read First Every Session

This project is a self-learning crypto trading bot being built as a business. Quality over speed, always.

### Session Startup Checklist
1. Read this file (.clinerules)
2. Read `tasks/INDEX.md` for current status
3. Check `tasks/active/` for in-progress work
4. Confirm with user what to work on before coding

---

## Mandatory Workflow

### For New Features
1. CREATE task file from `tasks/templates/TASK-TEMPLATE.md`
2. SPECIFY full requirements, get user approval
3. IMPLEMENT incrementally (one small piece at a time)
4. VERIFY with commands user can run
5. DOCUMENT all sections of task file
6. CLOSE only after user explicitly approves

### For Bug Fixes
1. CREATE task in `tasks/bugs/`
2. REPRODUCE the bug with specific steps
3. FIX with minimal changes
4. VERIFY fix and no regression
5. DOCUMENT root cause and solution

### For Refactors
1. CREATE task explaining why refactor needed
2. ENSURE tests exist before refactoring
3. IMPLEMENT in small, verifiable steps
4. VERIFY behavior unchanged

---

## Absolute Rules

- NEVER write code without user-approved specification
- NEVER claim something works without verification commands
- NEVER bypass risk management limits (they're hardcoded for a reason)
- NEVER use mock/fake/simulated market data
- ALWAYS provide exact commands user can run
- ALWAYS update `tasks/INDEX.md` after completing work
- DEFAULT to asking questions rather than assuming

---

## Definition of Done

A task is NOT complete until ALL checked:

- [ ] All acceptance criteria met
- [ ] Files Created/Modified tables populated
- [ ] Verification commands provided and executed
- [ ] Completion Notes written
- [ ] Task file moved to `tasks/completed/{phase}/`
- [ ] `tasks/INDEX.md` updated
- [ ] Related docs updated if applicable
- [ ] User explicitly approved closure

---

## Project-Specific Patterns

### Risk Limits (HARDCODED - DO NOT CHANGE)
| Limit | Value | Location |
|-------|-------|----------|
| Max per trade | 2% | `risk_manager.py` |
| Max exposure | 10% | `risk_manager.py` |
| Take profit | $1 | `trading_engine.py` |
| Tier 1 stop-loss | 3% | `coin_config.py` |
| Tier 2 stop-loss | 5% | `coin_config.py` |
| Tier 3 stop-loss | 7% | `coin_config.py` |
| Coin cooldown | 30 min | `risk_manager.py` |

### LLM Integration
- Ollama runs on Windows host at `172.27.144.1:11434`
- Model: `qwen2.5-coder:7b`
- Bot defaults to HOLD if LLM unavailable
- All LLM responses logged to `activity_log`

### Learning System
- Learnings require confidence ≥ 0.7 for rule promotion
- Rules enter 'testing' status for 10 trades
- Rules promoted to 'active' if ≥ 60% success rate
- Rules included in LLM prompt via `get_rules_as_text()`

### Cooldown Enforcement
- Cooldowns persist to `coin_cooldowns` table
- Loaded on startup via `_load_cooldowns_from_db()`
- LLM prompt marks cooled coins as "FORBIDDEN"

---

## Code Standards

### Naming
- Classes: `PascalCase`
- Functions/variables: `snake_case`
- Constants: `UPPER_CASE`

### Required in All Functions
- Type hints
- Docstring with Args/Returns
- Error handling with logging

### Database
- Always use parameterized queries (no f-strings)
- Use context managers for connections
- Log all errors with context

### Logging
- DEBUG: Detailed diagnostic
- INFO: Normal operations
- WARNING: Unexpected but handled
- ERROR: Failures
- CRITICAL: System cannot continue

---

## File Organization

```
src/
├── main.py              # Trading loop orchestration
├── database.py          # All SQLite operations
├── market_data.py       # CoinGecko API only
├── llm_interface.py     # Ollama communication only
├── trading_engine.py    # Trade execution only
├── risk_manager.py      # Risk validation only
├── learning_system.py   # Learning + rule management
├── coin_config.py       # Tier configuration
├── dashboard.py         # Flask UI only
├── daily_summary.py     # Report generation
├── metrics.py           # Performance metrics
└── volatility.py        # Volatility calculations
```

One responsibility per file. Don't mix concerns.

---

## Common Verification Commands

```bash
# Check bot is running
pgrep -f "python.*main.py"

# Check dashboard is running
curl -s http://localhost:8080/api/status | jq .

# Query database
sqlite3 data/trading_bot.db "SELECT COUNT(*) FROM closed_trades;"

# Check recent trades
sqlite3 data/trading_bot.db "SELECT coin_name, pnl_usd, closed_at FROM closed_trades ORDER BY closed_at DESC LIMIT 5;"

# Check active rules
sqlite3 data/trading_bot.db "SELECT id, rule_text, status FROM trading_rules WHERE status='active';"

# Test LLM connection
curl -s http://172.27.144.1:11434/api/tags | jq .

# View logs
tail -50 logs/bot.log
```

---

## Documentation Updates Required

After ANY task completion:
1. `tasks/INDEX.md` - Always
2. Task file completion notes - Always
3. `docs/architecture/*.md` - If architecture changed
4. `docs/operations/*.md` - If operational procedures changed
5. This file (`.clinerules`) - If new patterns discovered

---

**Last Updated:** February 2026
